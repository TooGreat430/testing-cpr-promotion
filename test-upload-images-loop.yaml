steps:
# 1. Pull and Push Images with a Filter
- name: 'gcr.io/cloud-builders/gcloud'
  id: Copy_Images
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # Define shell variables internally and ESCAPE the $ to prevent Cloud Build substitution.
    SOURCE_PROJECT_ID="bdi-onprem"
    SOURCE_AR_HOST="asia-southeast2-docker.pkg.dev"
    SOURCE_REPOSITORY="custom-prediction-routine-sdk"
    DEST_PROJECT_ID="me-data-internal-sandbox"
    DEST_AR_HOST="asia-southeast2-docker.pkg.dev"
    DEST_REPOSITORY="custom-prediction-routine-sdk"
    IMAGE_PREFIX="image_docker"

    # Configure Docker for cross-project access
    gcloud auth configure-docker ${SOURCE_AR_HOST} --quiet
    gcloud auth configure-docker ${DEST_AR_HOST} --quiet

    # Base URL for listing images in the source project
    SOURCE_REGISTRY_PATH=${SOURCE_AR_HOST}/${SOURCE_PROJECT_ID}/${SOURCE_REPOSITORY}
    DEST_REGISTRY_PATH=${DEST_AR_HOST}/${DEST_PROJECT_ID}/${DEST_REPOSITORY}

    echo "Listing images in source: ${SOURCE_REGISTRY_PATH}"

    # List images, filter by prefix, and extract the full image name
    gcloud artifacts docker images list ${SOURCE_REGISTRY_PATH} \
      --include-tags \
      --format='value(format("{0}:{1}", PACKAGE, TAG))' \
      --filter="PACKAGE~^${IMAGE_PREFIX}" \
      --limit=9999 \
      > /workspace/images_to_copy.txt

    if [ ! -s /workspace/images_to_copy.txt ]; then
        echo "No images found with prefix ${IMAGE_PREFIX}. Exiting."
        exit 0
    fi

    echo "Found images to copy:"
    cat /workspace/images_to_copy.txt

    # Loop through each image and copy it
    while IFS= read -r FULL_IMAGE_NAME
    do
      if [ -z "\$FULL_IMAGE_NAME" ]; then continue; fi # <-- ESCAPED

      # Full path of the source image
      SOURCE_IMAGE_TAG="\${SOURCE_REGISTRY_PATH}/\${FULL_IMAGE_NAME}" # <-- ESCAPED

      # Use the same image/tag name for the destination
      DEST_IMAGE_TAG="\${DEST_REGISTRY_PATH}/\${FULL_IMAGE_NAME}" # <-- ESCAPED

      echo "Pulling \${SOURCE_IMAGE_TAG}" # <-- ESCAPED
      docker pull "\${SOURCE_IMAGE_TAG}" # <-- ESCAPED

      echo "Tagging \${FULL_IMAGE_NAME} for destination project" # <-- ESCAPED
      docker tag "\${SOURCE_IMAGE_TAG}" "\${DEST_IMAGE_TAG}" # <-- ESCAPED

      echo "Pushing \${DEST_IMAGE_TAG}" # <-- ESCAPED
      docker push "\${DEST_IMAGE_TAG}" # <-- ESCAPED

      echo "Completed push of \${DEST_IMAGE_TAG}" # <-- ESCAPED
    done < /workspace/images_to_copy.txt
  env:
    - 'HOME=/root'

options:
  logging: CLOUD_LOGGING_ONLY
